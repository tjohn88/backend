# План внедрения химического OCSR конвейера (PDF -> DeepSeek -> MolScribe)

Этот документ описывает архитектуру и шаги реализации системы автоматического извлечения химических структур из PDF-документов в рамках проекта Backend.

## 1. Цель
Реализовать "офлайн" процесс обработки пачки PDF-файлов, который:
1.  Детектирует текстовые блоки и блоки с формулами.
2.  Вырезает изображения формул.
3.  Преобразует изображения формул в машиночитаемый формат (SMILES) с помощью MolScribe.
4.  Сохраняет результат в структурированную базу данных или JSON.

---

## 2. Архитектура данных (Папки)
Для работы "вручную" создается следующая структура:
- `uploads/input_pdfs/` — Входные PDF файлы.
- `uploads/temp_pages/` — Временные изображения страниц PDF (высокое разрешение).
- `uploads/crops/` — Вырезанные изображения формул (для MolScribe).
- `outputs/chem_results/` — Финальные JSON/txt файлы с результатами.

---

## 3. Этапы обработки (Pipeline)

### Этап 1: PDF -> Images (High-Res)
Использование библиотеки `PyMuPDF` (fitz).
- **Важно**: Для качественной работы MolScribe требуется разрешение не менее 300 DPI.
- Каждая страница PDF сохраняется как объект `PIL.Image`.

### Этап 2: Layout Analysis (DeepSeek-OCR-2)
Использование модели в режиме `grounding`.
- **Промпт**: `<image>\n<|grounding|>Convert the document to markdown and find all equations.`
- **Парсинг**: Извлечение координат из тегов `<|ref|>equation<|/ref|><|det|>[[x1,y1,x2,y2]]<|/det|>`.
- **Результат**: Список координат блоков для каждой страницы.

### Этап 3: Прецизионная резка (Cropping)
- Пересчет координат из нормализованного формата DeepSeek (0-999) в пиксели изображения.
- Сохранение каждого блока как `formula_N_page_M.jpg`.

### Этап 4: OCSR (MolScribe)
- Инициализация модели MolScribe.
- Пакетная подача "кропов" в модель.
- **Результат**: SMILES-строка (например, `CC(=O)OC1=CC=CC=C1C(=O)O`).

### Этап 5: Сборка и экспорт
- Сопоставление SMILES с текстом страницы.
- Запись в БД (таблица `chemical_structures`) или в результирующий JSON.

---

## 4. Необходимые доработки в коде Backend

1.  **SQL Схема**:
    ```sql
    CREATE TABLE chemical_structures (
        id SERIAL PRIMARY KEY,
        book_id INTEGER REFERENCES books(id),
        page_number INTEGER,
        smiles TEXT,
        inchi TEXT,
        bbox TEXT, -- Координаты [x1, y1, x2, y2]
        created_at TIMESTAMP DEFAULT NOW()
    );
    ```

2.  **Скрипт управления**:
    - Создание `scripts/4_chem_pipeline.py` как единой точки входа.
    - Реализация логики "продолжения": если скрипт упал, он должен начинать с последнего необработанного файла.

3.  **Зависимости**:
    - Установка `molscribe` и `rdkit`.
    - Настройка путей к весам моделей в `.env`.

---

## 5. Инструкция по запуску (Будущая)
1. Положить PDF в `uploads/input_pdfs/`.
2. Запустить: `python scripts/4_chem_pipeline.py`.
3. Мониторить прогресс в консоли и папке `uploads/crops/`.
4. Проверить результат в `outputs/chem_results/result.json`.
