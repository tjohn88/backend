# –§–∞–π–ª: convert_and_clean.py
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ PDF –∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –æ—á–∏—â–∞–µ—Ç –µ–≥–æ –æ—Ç –º—É—Å–æ—Ä–∞,
# –∫–æ—Ç–æ—Ä—ã–π –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ —Ñ–æ—Ä–º—É–ª –∏ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.

import os
import fitz  # PyMuPDF
import re

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
INPUT_PDF_NAME = "ORIRES.pdf"
OUTPUT_TXT_NAME = "rag_data.txt"
UPLOADS_DIR = "uploads" # –ü–∞–ø–∫–∞ –¥–ª—è –≤—Ö–æ–¥–Ω—ã—Ö –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# -----------------

def clean_text(text: str) -> str:
    """
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç "–º—É—Å–æ—Ä–∞".
    """
    cleaned_lines = []
    for line in text.split('\n'):
        # 1. –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
        line = line.strip()

        # 2. –ü—Ä–∞–≤–∏–ª–æ: –µ—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –±–æ–ª—å—à–µ 30% —Å–∏–º–≤–æ–ª–æ–≤ - –Ω–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏–ª–∏ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è,
        # —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –º—É—Å–æ—Ä –æ—Ç —Ñ–æ—Ä–º—É–ª—ã. –£–¥–∞–ª—è–µ–º –≤—Å—é —Å—Ç—Ä–æ–∫—É.
        if line:
            chars = len(line)
            # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "—Ö–æ—Ä–æ—à–∏—Ö" —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è)
            good_chars = len(re.findall(r'[\w\s.,!?;:()-]', line, re.UNICODE))
            if (chars - good_chars) / chars > 0.3:
                # print(f"–£–î–ê–õ–ï–ù–û (–º–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞): {line}") # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                continue

        # 3. –ü—Ä–∞–≤–∏–ª–æ: –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∞—è (–º–µ–Ω—å—à–µ 5 —Å–∏–º–≤–æ–ª–æ–≤) –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è
        # —á–∞—Å—Ç—å—é –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≥–æ–ª–æ–≤–æ–∫), —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –º—É—Å–æ—Ä.
        if len(line) < 5 and not line.endswith('.'):
             # print(f"–£–î–ê–õ–ï–ù–û (—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è): {line}") # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
             continue

        # 4. –ó–∞–º–µ–Ω—è–µ–º —Ä–∞–∑—Ä—ã–≤—ã —Å–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–º–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä–æ-\n–≤–∞–Ω–Ω—É—é") –Ω–∞ —Ü–µ–ª–æ–µ —Å–ª–æ–≤–æ
        line = line.replace('-\n', '')

        if line:
            cleaned_lines.append(line)

    # –°–æ–µ–¥–∏–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –µ–¥–∏–Ω—ã–π —Ç–µ–∫—Å—Ç, —Ä–∞–∑–¥–µ–ª—è—è –∞–±–∑–∞—Ü—ã –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
    return "\n\n".join(cleaned_lines)


def convert_and_clean_pdf():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF.
    """
    input_pdf_path = os.path.join(UPLOADS_DIR, INPUT_PDF_NAME)
    output_txt_path = os.path.join(UPLOADS_DIR, OUTPUT_TXT_NAME)

    if not os.path.exists(input_pdf_path):
        print(f"‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª '{INPUT_PDF_NAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–ø–∫–µ '{UPLOADS_DIR}'!")
        return

    print(f"‚ñ∂Ô∏è  –ù–∞—á–∏–Ω–∞—é –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫—É —Ñ–∞–π–ª–∞: {input_pdf_path}")
    
    try:
        # 1. –ò–∑–≤–ª–µ–∫–∞–µ–º "—Å—ã—Ä–æ–π" —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é PyMuPDF
        doc = fitz.open(input_pdf_path)
        raw_text = ""
        for page in doc:
            raw_text += page.get_text("text")
        doc.close()

        # 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏
        print("üßπ –ü—Ä–æ–∏–∑–≤–æ–∂—É –æ—á–∏—Å—Ç–∫—É —Ç–µ–∫—Å—Ç–∞ –æ—Ç –º—É—Å–æ—Ä–∞...")
        clean_content = clean_text(raw_text)

        # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(output_txt_path, 'w', encoding='utf-8') as f:
            f.write(clean_content)
            
        print(f"‚úÖ –£–°–ü–ï–•! –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_txt_path}")

    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    if not os.path.exists(UPLOADS_DIR):
        os.makedirs(UPLOADS_DIR)
    convert_and_clean_pdf()